---
import Input from "~/components/Input.astro";
import { db } from "~/contacts.ts";
import Layout from "../_layout.astro";
import Label from "~/components/Label.astro";
import A from "~/components/A.astro";

const query = Astro.url.searchParams.get("q");
const page = Number(Astro.url.searchParams.get("page")) || 1;
const results = query
	? await db.search({
			query,
			page,
	  })
	: await db.all(page);

const nextPageUrl = new URL(Astro.url);
nextPageUrl.searchParams.set("page", String(page + 1));

const prevPageUrl = new URL(Astro.url);
prevPageUrl.searchParams.set("page", String(page - 1));
---

<Layout>
	<main class="flex flex-col items-start gap-8">
		<form action="/contacts" method="get">
			<Label for="search" class="sr-only">Search</Label>
			<Input
				id="search"
				name="q"
				placeholder="Search"
				type="search"
				value={query}
			/>
		</form>
		<table class="w-full max-w-full border-collapse divide-y indent-0">
			<thead>
				<tr>
					<th
						class="px-3 py-3.5 text-left text-sm font-semibold first-of-type:pl-0"
						scope="col">ID</th
					>
					<th
						class="px-3 py-3.5 text-left text-sm font-semibold first-of-type:pl-0"
						scope="col">First</th
					>
					<th
						class="px-3 py-3.5 text-left text-sm font-semibold first-of-type:pl-0"
						scope="col">Last</th
					>
					<th
						class="px-3 py-3.5 text-left text-sm font-semibold first-of-type:pl-0"
						scope="col">Email</th
					>
					<th
						class="px-3 py-3.5 text-left text-sm font-semibold first-of-type:pl-0"
						scope="col">Phone</th
					>
					<th></th>
				</tr>
			</thead>
			<tbody class="divide-y">
				{
					results.contacts.map((contact) => (
						<tr>
							<td class="whitespace-nowrap px-3 py-4 text-left text-sm first-of-type:pl-0">
								{contact.id}
							</td>
							<td class="whitespace-nowrap px-3 py-4 text-left text-sm first-of-type:pl-0">
								{contact.firstName}
							</td>
							<td class="whitespace-nowrap px-3 py-4 text-left text-sm first-of-type:pl-0">
								{contact.lastName}
							</td>
							<td class="whitespace-nowrap px-3 py-4 text-left text-sm first-of-type:pl-0">
								{contact.email}
							</td>
							<td class="whitespace-nowrap px-3 py-4 text-left text-sm first-of-type:pl-0">
								{contact.phone}
							</td>
							<td class="flex items-center justify-end gap-2 whitespace-nowrap px-3 py-4 text-sm first-of-type:pl-0">
								<A href={`/contacts/${contact.id}/edit`}>
									Edit
								</A>
								<A href={`/contacts/${contact.id}`}>View</A>
							</td>
						</tr>
					))
				}
			</tbody>
		</table>
		<nav class="flex items-center gap-3">
			{page > 1 ? <A href={prevPageUrl.toString()}>Previous</A> : null}
			{results.hasMore ? <A href={nextPageUrl.toString()}>Next</A> : null}
		</nav>
		<A href="/contacts/new">Add Contact</A>
	</main>
</Layout>
